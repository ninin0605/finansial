<html class="light" lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Premium Services Dashboard V2</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#3498db",
                        secondary: "#f39c12",
                        "background-light": "#F8FAFC",
                        "background-dark": "#0F172A",
                    },
                    fontFamily: {
                        display: ["Plus Jakarta Sans", "sans-serif"],
                    },
                    borderRadius: {
                        DEFAULT: "1.25rem",
                    },
                },
            },
        };
    </script>
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: max(884px, 100dvh);
        }

        .glass-header {
            background: rgba(52, 152, 219, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        [onclick]:active,
        .cursor-pointer:active,
        .icon-card:active {
            transform: scale(0.97);
            background-color: rgba(52, 152, 219, 0.1) !important;
            transition: all 0.1s ease-in-out;
        }

        .icon-card:active div,
        .icon-card:active span,
        [onclick]:active span.material-icons-round,
        [onclick]:active span.material-symbols-outlined {
            color: #3498db !important;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Page-based Navigation Styles */
        .app-page {
            position: absolute;
            inset: 0;
            background: inherit;
            overflow-y: auto;
            z-index: 40;
            display: none;
            flex-direction: column;
        }

        .app-page.active {
            display: flex;
        }

        .app-page .page-content {
            flex: 1;
            overflow-y: auto;
            padding-bottom: 96px;
            /* Spacing for bottom nav or general padding */
        }
    </style>
</head>

<body class="bg-background-light dark:bg-background-dark min-h-screen flex items-center justify-center p-4">
    <!-- Main Phone Frame -->
    <div
        class="relative w-full max-w-[390px] h-[844px] bg-white dark:bg-slate-900 overflow-hidden shadow-2xl border-[8px] border-slate-200 dark:border-slate-800 rounded-[3rem]">

        <!-- Status Bar Removed -->


        <!-- Main Dashboard Page -->
        <div id="pageHome" class="app-page active">
            <!-- Header -->
            <div
                class="glass-header text-white pt-14 pb-8 px-6 rounded-b-[2.5rem] relative overflow-hidden z-20 shrink-0">
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-md">
                            <span class="material-icons-round text-white">account_balance_wallet</span>
                        </div>
                        <div>
                            <h1 class="text-sm font-medium opacity-80">Finansialku</h1>
                            <p class="text-xs opacity-60">Smart Management</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-around text-center mt-2">
                    <div id="tabHome" class="opacity-60 px-2 cursor-pointer active:scale-95 transition-transform"
                        onclick="navigateTo('pageHome')">
                        <p class="text-[10px] font-bold uppercase tracking-wider">Beranda</p>
                    </div>
                    <div id="tabRekap"
                        class="opacity-60 px-2 cursor-pointer active:opacity-100 active:scale-95 transition-all"
                        onclick="navigateTo('pageRekap')">
                        <p class="text-[10px] font-bold uppercase tracking-wider">Laporan</p>
                    </div>
                    <div id="tabTransaksi"
                        class="opacity-60 px-2 cursor-pointer active:opacity-100 active:scale-95 transition-all"
                        onclick="navigateTo('pageTransaksi')">
                        <p class="text-[10px] font-bold uppercase tracking-wider">Riwayat</p>
                    </div>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="absolute inset-0 pt-[160px] overflow-y-auto pb-24 px-6 hide-scrollbar flex flex-col gap-6">
                <!-- Saldo Overview -->
                <div
                    class="bg-white dark:bg-slate-800 p-6 rounded-[2rem] shadow-xl shadow-slate-200/50 dark:shadow-none relative z-10 border border-slate-50 dark:border-slate-700">
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">Pemasukan</span>
                            <span id="totalPemasukan" class="text-primary font-bold">Rp 0</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-slate-500 dark:text-slate-400 text-sm">Pengeluaran</span>
                            <span id="totalPengeluaran" class="text-rose-500 font-bold">-Rp 0</span>
                        </div>
                        <div class="h-px bg-slate-100 dark:bg-slate-700 w-full"></div>
                        <div class="flex justify-between items-center pt-1">
                            <div class="flex items-center gap-2">
                                <span class="text-slate-900 dark:text-white font-semibold">Saldo Saat ini</span>
                                <button onclick="toggleBalanceVisibility()"
                                    class="text-slate-400 hover:text-primary transition-colors">
                                    <span id="balanceEyeIcon" class="material-icons-round text-sm">visibility</span>
                                </button>
                            </div>
                            <span id="totalSaldo" class="text-primary text-lg font-extrabold">Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- Main Menu (Swapped Content) -->
                <div
                    class="bg-white dark:bg-slate-800 rounded-[2rem] p-6 shadow-lg shadow-slate-100 dark:shadow-none border border-slate-50 dark:border-slate-700">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="flex flex-col items-center gap-2 icon-card cursor-pointer"
                            onclick="navigateTo('pagePemasukan')">
                            <div
                                class="w-14 h-14 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-full flex items-center justify-center text-primary shadow-sm">
                                <span class="material-icons-round text-3xl">attach_money</span>
                            </div>
                            <span
                                class="text-[10px] font-semibold text-slate-600 dark:text-slate-300 text-center">Pemasukan</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 icon-card cursor-pointer"
                            onclick="navigateTo('pagePengeluaran')">
                            <div
                                class="w-14 h-14 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-700 rounded-full flex items-center justify-center text-primary shadow-sm">
                                <span class="material-icons-round text-3xl">payments</span>
                            </div>
                            <span
                                class="text-[10px] font-semibold text-slate-600 dark:text-slate-300 text-center">Pengeluaran</span>
                        </div>
                    </div>
                </div>

                <!-- Other Services (Swapped Content) -->
                <div>
                    <div class="flex justify-between items-center mb-4 px-2">
                        <h2 class="text-slate-900 dark:text-white font-bold text-base">Menu Utama</h2>
                        <span class="text-primary text-xs font-semibold cursor-pointer">Lihat Semua</span>
                    </div>
                    <div class="grid grid-cols-3 gap-4">
                        <div class="flex flex-col items-center gap-2 icon-card cursor-pointer"
                            onclick="navigateTo('pageRekap')">
                            <div
                                class="w-12 h-12 bg-orange-100 dark:bg-orange-900/30 rounded-2xl flex items-center justify-center text-orange-500 shadow-sm">
                                <span class="material-icons-round text-2xl">edit_note</span>
                            </div>
                            <span class="text-[10px] font-medium text-slate-500 dark:text-slate-400 text-center">Catat
                                Keuangan</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 icon-card cursor-pointer"
                            onclick="navigateTo('pageTransaksi')">
                            <div
                                class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center text-blue-500 shadow-sm">
                                <span class="material-icons-round text-2xl">swap_horiz</span>
                            </div>
                            <span
                                class="text-[10px] font-medium text-slate-500 dark:text-slate-400 text-center">Transaksi</span>
                        </div>
                        <div class="flex flex-col items-center gap-2 icon-card cursor-pointer"
                            onclick="navigateTo('pageAnggaran')">
                            <div
                                class="w-12 h-12 bg-teal-100 dark:bg-teal-900/30 rounded-2xl flex items-center justify-center text-teal-500 shadow-sm">
                                <span class="material-icons-round text-2xl">savings</span>
                            </div>
                            <span
                                class="text-[10px] font-medium text-slate-500 dark:text-slate-400 text-center">Anggaran</span>
                        </div>
                    </div>
                </div>


            </div>
        </div> <!-- End #pageHome -->

        <!-- Bottom Navigation -->
        <div
            class="absolute bottom-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-t border-slate-100 dark:border-slate-800 h-20 px-6 flex justify-between items-center z-50">
            <div id="navHome"
                class="flex flex-col items-center gap-1 text-slate-400 cursor-pointer active:scale-90 transition-transform"
                onclick="navigateTo('pageHome')">
                <span class="material-icons-round">home</span>
                <span class="text-[10px]">Beranda</span>
            </div>
            <div id="navRekap"
                class="flex flex-col items-center gap-1 text-slate-400 cursor-pointer active:text-primary active:scale-90 transition-all"
                onclick="navigateTo('pageRekap')">
                <span class="material-icons-round">receipt_long</span>
                <span class="text-[10px]">Laporan</span>
            </div>
            <div id="navTransaksi"
                class="flex flex-col items-center gap-1 text-slate-400 cursor-pointer active:text-primary active:scale-90 transition-all"
                onclick="navigateTo('pageTransaksi')">
                <span class="material-icons-round">history</span>
                <span class="text-[10px]">Riwayat</span>
            </div>
            <div id="navProfil"
                class="flex flex-col items-center gap-1 text-slate-400 cursor-pointer active:text-primary active:scale-90 transition-all"
                onclick="navigateTo('pageProfil')">
                <span class="material-icons-round">person</span>
                <span class="text-[10px]">Profil</span>
            </div>
        </div>

        <!-- Home Indicator -->
        <div
            class="absolute bottom-1.5 left-1/2 -translate-x-1/2 w-32 h-1 bg-slate-300 dark:bg-slate-700 rounded-full z-50">
        </div>

        <!-- All Feature Pages (Inside Frame) -->
        <!-- Page Profil -->
        <div id="pageProfil" class="app-page">
            <div
                class="glass-header text-white pt-10 pb-12 px-6 rounded-b-[3rem] relative overflow-hidden flex flex-col items-center shrink-0">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-white/10 rounded-full blur-3xl"></div>
                <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-white/10 rounded-full blur-3xl"></div>
                <button onclick="navigateTo('pageHome')"
                    class="absolute top-4 left-4 w-8 h-8 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-md">
                    <span class="material-icons-round text-sm">arrow_back</span>
                </button>
                <div class="relative mb-3 group cursor-pointer" onclick="triggerPhotoUpload()">
                    <div
                        class="w-20 h-20 rounded-full border-4 border-white/30 p-1 transition-transform group-active:scale-95">
                        <img id="modalAvatar" alt="Profile" class="w-full h-full object-cover rounded-full"
                            src="https://lh3.googleusercontent.com/aida-public/AB6AXuDztHJzjTmkHgLvK0kciF_bwKJ60qJcX11f5Z7dPqDriXeZ2KdbIswMTzj4NhrvHxzeYvNAbGSdyfzr1ORkh0IG2_RqoVHhoxpFPC_wB65PCUIEYaYTktRrpHZk-zGJxeQrXBLRGryUKZvFA4HFlFzNjr6p1AMSxYQXa-5WBkv_FRGf3y08qbVp_n80Jwuv1GvNtwse6qpTqLP4vE3-5CLmnNuFdoDT811Wzi4GzcUy_XYEIDgUFV1ude2VsHqXaRtQNynN2cCxss2A" />
                    </div>
                    <div
                        class="absolute bottom-0 right-0 w-6 h-6 bg-primary border-2 border-white dark:border-slate-900 rounded-full flex items-center justify-center text-white shadow-sm">
                        <span class="material-icons-round text-[12px]">photo_camera</span>
                    </div>
                </div>
                <h1 id="modalProfileName" class="text-lg font-bold"></h1>
                <div class="mt-1 px-3 py-0.5 bg-white/20 backdrop-blur-md rounded-full border border-white/10">
                    <span class="text-[8px] font-bold uppercase tracking-widest text-white/90">Premium Member</span>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 hide-scrollbar space-y-3">
                <div onclick="navigateTo('pagePengaturan')"
                    class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl flex items-center justify-between group cursor-pointer active:bg-blue-50 dark:active:bg-blue-900/20 active:scale-[0.98] transition-all border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-9 h-9 bg-orange-100 dark:bg-orange-900/30 rounded-xl flex items-center justify-center text-orange-500">
                            <span class="material-symbols-outlined text-[18px]">settings</span>
                        </div>
                        <span class="text-xs font-semibold text-slate-700 dark:text-slate-200">Pengaturan
                            Aplikasi</span>
                    </div>
                    <span
                        class="material-symbols-outlined text-slate-300 dark:text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div class="pt-4 space-y-3">
                    <button id="btnLogin" onclick="handleLogin()"
                        class="w-full bg-indigo-50 dark:bg-indigo-900/10 text-indigo-500 py-3 rounded-2xl font-bold text-xs tracking-wide flex items-center justify-center gap-2 border border-indigo-100 dark:border-indigo-900/20 active:bg-indigo-100 dark:active:bg-indigo-900/40 active:scale-[0.98] transition-all hidden">
                        <span class="material-symbols-outlined text-[18px]">login</span>
                        Masuk Akun
                    </button>
                    <button id="btnLogout" onclick="handleLogout()"
                        class="w-full bg-rose-50 dark:bg-rose-900/10 text-rose-500 py-3 rounded-2xl font-bold text-xs tracking-wide flex items-center justify-center gap-2 border border-rose-100 dark:border-rose-900/20 active:bg-rose-100 dark:active:bg-rose-900/40 active:scale-[0.98] transition-all hidden">
                        <span class="material-symbols-outlined text-[18px]">logout</span>
                        Keluar Akun
                    </button>
                </div>
            </div>
        </div>

        <!-- Page Pengaturan -->
        <div id="pagePengaturan" class="app-page">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center gap-4 shrink-0">
                <button onclick="navigateTo('pageProfil')"
                    class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                    <span class="material-icons-round text-slate-500 dark:text-slate-400 text-sm">arrow_back</span>
                </button>
                <h2 class="text-base font-bold text-slate-900 dark:text-white">Pengaturan</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-3 hide-scrollbar">
                <div onclick="navigateTo('pageDataPribadi')"
                    class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl flex items-center justify-between group cursor-pointer active:bg-blue-50 dark:active:bg-blue-900/20 active:scale-[0.98] transition-all border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-9 h-9 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center text-primary">
                            <span class="material-symbols-outlined text-[18px]">person</span>
                        </div>
                        <span class="text-xs font-semibold text-slate-700 dark:text-slate-200">Informasi Pribadi</span>
                    </div>
                    <span
                        class="material-symbols-outlined text-slate-300 dark:text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div onclick="navigateTo('pageKeamanan')"
                    class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl flex items-center justify-between group cursor-pointer active:bg-blue-50 dark:active:bg-blue-900/20 active:scale-[0.98] transition-all border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-9 h-9 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl flex items-center justify-center text-indigo-500">
                            <span class="material-symbols-outlined text-[18px]">lock</span>
                        </div>
                        <span class="text-xs font-semibold text-slate-700 dark:text-slate-200">Keamanan Akun</span>
                    </div>
                    <span
                        class="material-symbols-outlined text-slate-300 dark:text-slate-600 text-[18px]">chevron_right</span>
                </div>
                <div onclick="document.documentElement.classList.toggle('dark')"
                    class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl flex items-center justify-between group cursor-pointer active:bg-blue-50 dark:active:bg-blue-900/20 active:scale-[0.98] transition-all border border-slate-100 dark:border-slate-700">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-9 h-9 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center text-purple-500">
                            <span class="material-symbols-outlined text-[18px]">dark_mode</span>
                        </div>
                        <span class="text-xs font-semibold text-slate-700 dark:text-slate-200">Mode Tampilan</span>
                    </div>
                    <div class="w-10 h-6 bg-slate-200 dark:bg-primary rounded-full relative p-1 transition-colors">
                        <div class="w-4 h-4 bg-white rounded-full transition-transform transform dark:translate-x-4">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Data Pribadi -->
        <div id="pageDataPribadi" class="app-page">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center gap-4 shrink-0">
                <button onclick="navigateTo('pagePengaturan')"
                    class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                    <span class="material-icons-round text-slate-500 dark:text-slate-400 text-sm">arrow_back</span>
                </button>
                <h2 class="text-base font-bold text-slate-900 dark:text-white">Data Pribadi</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-4 hide-scrollbar">
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl">
                    <p class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Nama Lengkap</p>
                    <input type="text" id="editNamaLengkap"
                        class="w-full bg-transparent text-sm font-bold text-slate-900 dark:text-white focus:outline-none border-b border-white/10 pb-1"
                        value="">
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl">
                    <p class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Email</p>
                    <input type="email" id="editEmail"
                        class="w-full bg-transparent text-sm font-bold text-slate-900 dark:text-white focus:outline-none border-b border-white/10 pb-1"
                        value="">
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl">
                    <p class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Nomor Telepon</p>
                    <input type="tel" id="editPhone"
                        class="w-full bg-transparent text-sm font-bold text-slate-900 dark:text-white focus:outline-none border-b border-white/10 pb-1"
                        value="">
                </div>
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl">
                    <p class="text-[10px] uppercase tracking-widest text-slate-400 mb-1">Alamat</p>
                    <textarea id="editAddress" rows="2"
                        class="w-full bg-transparent text-xs font-bold text-slate-900 dark:text-white focus:outline-none border-b border-white/10 pb-1 resize-none leading-relaxed"></textarea>
                </div>
                <button onclick="savePersonalData()"
                    class="w-full mt-2 bg-primary text-white py-4 rounded-2xl font-bold text-sm tracking-wide shadow-lg shadow-primary/30 active:bg-blue-600 active:scale-95 transition-all">
                    Simpan Perubahan
                </button>
            </div>
        </div>

        <!-- Page Keamanan -->
        <div id="pageKeamanan" class="app-page">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center gap-4 shrink-0">
                <button onclick="navigateTo('pagePengaturan')"
                    class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                    <span class="material-icons-round text-slate-500 dark:text-slate-400 text-sm">arrow_back</span>
                </button>
                <h2 class="text-base font-bold text-slate-900 dark:text-white">Reset Kata Sandi</h2>
            </div>
            <div class="flex-1 overflow-y-auto p-6 hide-scrollbar">
                <form onsubmit="handleResetSandi(event)" class="space-y-4">
                    <div>
                        <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Sandi
                            Lama</label>
                        <div class="relative">
                            <input type="password" id="sandiLama"
                                class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                placeholder="••••••••">
                            <button type="button" onclick="togglePasswordVisibility('sandiLama', 'eyeLama')"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                                <span id="eyeLama" class="material-symbols-outlined text-[20px]">visibility</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Sandi
                            Baru</label>
                        <div class="relative">
                            <input type="password" id="sandiBaru"
                                class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                placeholder="••••••••">
                            <button type="button" onclick="togglePasswordVisibility('sandiBaru', 'eyeBaru')"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                                <span id="eyeBaru" class="material-symbols-outlined text-[20px]">visibility</span>
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Konfirmasi
                            Sandi</label>
                        <div class="relative">
                            <input type="password" id="sandiKonfirmasi"
                                class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-primary"
                                placeholder="••••••••">
                            <button type="button" onclick="togglePasswordVisibility('sandiKonfirmasi', 'eyeKonfirmasi')"
                                class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
                                <span id="eyeKonfirmasi" class="material-symbols-outlined text-[20px]">visibility</span>
                            </button>
                        </div>
                    </div>
                    <button type="submit"
                        class="w-full mt-2 bg-primary text-white py-4 rounded-2xl font-bold text-sm tracking-wide shadow-lg shadow-primary/30 active:scale-95 transition-all">
                        Update Kata Sandi
                    </button>
                </form>
            </div>
        </div>

        <!-- Page Notif -->
        <div id="pageNotif" class="app-page">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('pageHome')"
                        class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                        <span class="material-icons-round text-slate-500 dark:text-slate-400 text-sm">arrow_back</span>
                    </button>
                    <h2 class="text-base font-bold text-slate-900 dark:text-white">Pemberitahuan</h2>
                </div>
                <button onclick="alert('Semua ditandai dibaca')"
                    class="text-[10px] font-bold text-primary uppercase tracking-widest">Tandai Dibaca</button>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-4 hide-scrollbar">
                <!-- Today -->
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-3 ml-2">Hari Ini</p>
                    <div class="space-y-3">
                        <div
                            class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 flex gap-4">
                            <div
                                class="w-10 h-10 bg-green-100 dark:bg-green-900/30 rounded-xl flex items-center justify-center text-green-500 shrink-0">
                                <span class="material-icons-round">payments</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white mb-0.5">Pemasukan Berhasil!
                                </p>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-relaxed">Dana sebesar
                                    Rp
                                    2.500.000 telah masuk ke saldo utama Anda.</p>
                                <p class="text-[9px] text-slate-400 mt-2">2 jam yang lalu</p>
                            </div>
                        </div>
                        <div
                            class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 flex gap-4">
                            <div
                                class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-xl flex items-center justify-center text-orange-500 shrink-0">
                                <span class="material-icons-round">warning</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white mb-0.5">Ingat Anggaran!</p>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-relaxed">Anggaran
                                    "Makan &
                                    Minum" sudah mencapai 85% dari limit.</p>
                                <p class="text-[9px] text-slate-400 mt-2">5 jam yang lalu</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Yesterday -->
                <div>
                    <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-3 ml-2">Kemarin</p>
                    <div class="space-y-3">
                        <div
                            class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 flex gap-4 opacity-60">
                            <div
                                class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center text-blue-500 shrink-0">
                                <span class="material-icons-round">info</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white mb-0.5">Tips Hemat</p>
                                <p class="text-[10px] text-slate-500 dark:text-slate-400 leading-relaxed">Hemat 10%
                                    pengeluaran dengan menabung di awal bulan.</p>
                                <p class="text-[9px] text-slate-400 mt-2">1 hari yang lalu</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Anggaran -->
        <div id="pageAnggaran" class="app-page">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex flex-col gap-4 shrink-0">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <button onclick="navigateTo('pageHome')"
                            class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center active:bg-blue-100 dark:active:bg-blue-900/40 active:scale-95 transition-all">
                            <span
                                class="material-icons-round text-slate-500 dark:text-slate-400 text-sm active:text-primary">arrow_back</span>
                        </button>
                        <h2 class="text-base font-bold text-slate-900 dark:text-white">Anggaran Kamu</h2>
                    </div>
                </div>
                <!-- Month Filter -->
                <div
                    class="flex items-center justify-between bg-slate-50 dark:bg-slate-800/50 p-2 rounded-2xl border border-slate-100 dark:border-slate-700">
                    <button onclick="changeBrowseMonth(-1)"
                        class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-primary transition-colors">
                        <span class="material-icons-round text-sm">chevron_left</span>
                    </button>
                    <span id="budgetMonthDisplay"
                        class="text-xs font-bold text-slate-700 dark:text-white uppercase tracking-widest">Februari
                        2026</span>
                    <button onclick="changeBrowseMonth(1)"
                        class="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-primary transition-colors">
                        <span class="material-icons-round text-sm">chevron_right</span>
                    </button>

                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-6 space-y-6 hide-scrollbar">
                <!-- Item: Kebutuhan Pokok -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-blue-100 dark:bg-blue-900/30 rounded-xl flex items-center justify-center text-primary">
                                <span class="material-icons-round">home</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white">Kebutuhan Pokok</p>
                                <p class="text-[9px] text-slate-400">Terpakai: <span id="usedPokok">Rp 0</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] uppercase tracking-widest text-slate-400 mb-1">Limit</p>
                            <input type="number" id="limitPokok" oninput="updateBudgetProgress('Pokok')"
                                class="w-24 bg-slate-50 dark:bg-slate-800 text-right text-xs font-bold text-slate-900 dark:text-white px-2 py-1 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary"
                                value="">
                        </div>
                    </div>
                    <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressPokok" class="h-full bg-primary rounded-full transition-all duration-500"
                            style="width: 70%"></div>
                    </div>

                </div>

                <!-- Item: Transportasi -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-teal-100 dark:bg-teal-900/30 rounded-xl flex items-center justify-center text-teal-500">
                                <span class="material-icons-round">commute</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white">Transportasi</p>
                                <p class="text-[9px] text-slate-400">Terpakai: <span id="usedTransport">Rp 0</span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] uppercase tracking-widest text-slate-400 mb-1">Limit</p>
                            <input type="number" id="limitTransport" oninput="updateBudgetProgress('Transport')"
                                class="w-24 bg-slate-50 dark:bg-slate-800 text-right text-xs font-bold text-slate-900 dark:text-white px-2 py-1 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary"
                                value="">
                        </div>
                    </div>
                    <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressTransport" class="h-full bg-teal-500 rounded-full transition-all duration-500"
                            style="width: 45%">
                        </div>
                    </div>

                </div>

                <!-- Item: Hiburan -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-purple-100 dark:bg-purple-900/30 rounded-xl flex items-center justify-center text-purple-500">
                                <span class="material-icons-round">movie</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white">Hiburan</p>
                                <p class="text-[9px] text-slate-400">Terpakai: <span id="usedHiburan">Rp 0</span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] uppercase tracking-widest text-slate-400 mb-1">Limit</p>
                            <input type="number" id="limitHiburan" oninput="updateBudgetProgress('Hiburan')"
                                class="w-24 bg-slate-50 dark:bg-slate-800 text-right text-xs font-bold text-slate-900 dark:text-white px-2 py-1 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary"
                                value="">
                        </div>
                    </div>
                    <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressHiburan" class="h-full bg-rose-500 rounded-full transition-all duration-500"
                            style="width: 90%">
                        </div>
                    </div>

                </div>

                <!-- Item: Tagihan -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-orange-100 dark:bg-orange-900/30 rounded-xl flex items-center justify-center text-orange-500">
                                <span class="material-icons-round">receipt</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white">Tagihan</p>
                                <p class="text-[9px] text-slate-400">Terpakai: <span id="usedTagihan">Rp 0</span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] uppercase tracking-widest text-slate-400 mb-1">Limit</p>
                            <input type="number" id="limitTagihan" oninput="updateBudgetProgress('Tagihan')"
                                class="w-24 bg-slate-50 dark:bg-slate-800 text-right text-xs font-bold text-slate-900 dark:text-white px-2 py-1 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary"
                                value="">
                        </div>
                    </div>
                    <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressTagihan" class="h-full bg-orange-500 rounded-full transition-all duration-500"
                            style="width: 20%"></div>
                    </div>

                </div>

                <!-- Item: Lain-lain -->
                <div class="space-y-3">
                    <div class="flex justify-between items-end">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 bg-slate-100 dark:bg-slate-800 rounded-xl flex items-center justify-center text-slate-500">
                                <span class="material-icons-round">category</span>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-slate-800 dark:text-white">Lain-lain</p>
                                <p class="text-[9px] text-slate-400">Terpakai: <span id="usedLain">Rp 0</span></p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-[8px] uppercase tracking-widest text-slate-400 mb-1">Limit</p>
                            <input type="number" id="limitLain" oninput="updateBudgetProgress('Lain')"
                                class="w-24 bg-slate-50 dark:bg-slate-800 text-right text-xs font-bold text-slate-900 dark:text-white px-2 py-1 rounded-lg focus:outline-none focus:ring-1 focus:ring-primary"
                                value="">
                        </div>
                    </div>
                    <div class="h-2 bg-slate-100 dark:bg-slate-800 rounded-full overflow-hidden">
                        <div id="progressLain" class="h-full bg-slate-500 rounded-full transition-all duration-500"
                            style="width: 10%"></div>
                    </div>

                </div>
            </div>
        </div>



        <!-- Page Pemasukan -->
        <div id="pagePemasukan" class="app-page">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('pageHome')"
                        class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                        <span class="material-icons-round text-slate-500 dark:text-slate-400 text-sm">arrow_back</span>
                    </button>
                    <h2 class="text-base font-bold text-slate-900 dark:text-white">Tambah Pemasukan</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 hide-scrollbar">
                <form id="pemasukanForm" onsubmit="savePemasukan(event)" class="space-y-6">
                    <div>
                        <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Jumlah
                            Uang</label>
                        <div class="relative">
                            <span
                                class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">Rp</span>
                            <input type="text" id="jumlahPemasukan" placeholder="0"
                                class="w-full pl-16 pr-6 py-5 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-[2rem] text-slate-900 dark:text-white font-bold text-2xl focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                oninput="formatRupiah(this)" required>
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Keterangan</label>
                        <input type="text" id="keteranganPemasukan" placeholder="Contoh: Gaji bulanan"
                            class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                    </div>
                    <button type="submit"
                        class="w-full py-5 bg-primary text-white font-bold rounded-2xl shadow-xl shadow-primary/30 transition-all active:bg-blue-600 active:scale-95 text-sm tracking-wide">
                        Simpan Pemasukan
                    </button>
                </form>
            </div>
        </div>

        <!-- Page Pengeluaran -->
        <div id="pagePengeluaran" class="app-page">
            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between shrink-0">
                <div class="flex items-center gap-3">
                    <button onclick="navigateTo('pageHome')"
                        class="w-8 h-8 rounded-full bg-slate-50 dark:bg-slate-800 flex items-center justify-center">
                        <span class="material-icons-round text-slate-500 dark:text-slate-400 text-sm">arrow_back</span>
                    </button>
                    <h2 class="text-base font-bold text-slate-900 dark:text-white">Tambah Pengeluaran</h2>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-6 hide-scrollbar">
                <form id="pengeluaranForm" onsubmit="savePengeluaran(event)" class="space-y-6">
                    <div>
                        <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Jumlah
                            Uang</label>
                        <div class="relative">
                            <span
                                class="absolute left-6 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-lg">Rp</span>
                            <input type="text" id="jumlahPengeluaran" placeholder="0"
                                class="w-full pl-16 pr-6 py-5 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-[2rem] text-rose-500 dark:text-rose-400 font-bold text-2xl focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent transition-all"
                                oninput="formatRupiah(this)" required>
                        </div>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Kategori</label>
                        <select id="kategoriPengeluaran"
                            class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent transition-all">
                            <option value="Pokok">Kebutuhan Pokok</option>
                            <option value="Transport">Transportasi</option>
                            <option value="Hiburan">Hiburan</option>
                            <option value="Tagihan">Tagihan</option>
                            <option value="Lain">Lain-lain</option>
                        </select>
                    </div>
                    <div>
                        <label
                            class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Keterangan</label>
                        <input type="text" id="keteranganPengeluaran" placeholder="Contoh: Belanja bulanan"
                            class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm text-slate-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-rose-500 focus:border-transparent transition-all">
                    </div>
                    <button type="submit"
                        class="w-full py-5 bg-rose-500 text-white font-bold rounded-2xl shadow-xl shadow-rose-500/30 transition-all active:bg-rose-600 active:scale-95 text-sm tracking-wide">
                        Simpan Pengeluaran
                    </button>
                </form>
            </div>
        </div>

        <!-- Page Rekap -->
        <div id="pageRekap" class="app-page">
            <!-- Header -->
            <div class="px-6 pt-12 pb-4 sticky top-0 bg-white dark:bg-slate-900 z-30 transition-all">
                <div class="flex items-center gap-4 mb-6">
                    <button onclick="navigateTo('pageHome')"
                        class="w-10 h-10 -ml-2 rounded-full flex items-center justify-center text-slate-400 hover:text-slate-800 dark:hover:text-white transition-colors">
                        <span class="material-icons-round text-2xl">chevron_left</span>
                    </button>
                    <h2 class="text-xl font-bold text-slate-900 dark:text-white">Laporan Keuangan</h2>
                </div>

                <!-- Filters -->
                <div class="flex gap-3">
                    <button onclick="toggleRekapTypeFilter()" id="rekapTypeBtn"
                        class="flex items-center gap-2 px-4 py-2.5 bg-indigo-500/10 text-indigo-500 rounded-xl text-xs font-bold active:scale-95 transition-all">
                        <span id="rekapTypeLabel">Semua</span>
                        <span class="material-icons-round text-base">expand_more</span>
                    </button>
                    <button onclick="openDatePickerModal('rekap')"
                        class="flex items-center gap-2 px-4 py-2.5 border border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 rounded-xl text-xs font-bold active:scale-95 transition-all">
                        <span class="material-icons-round text-base">calendar_today</span>
                        <span>Tanggal</span>
                    </button>
                </div>
            </div>

            <!-- List Content -->
            <div id="rekapList" class="flex-1 overflow-y-auto px-6 pb-24 space-y-3 hide-scrollbar pt-2">
                <!-- Data injected here -->
            </div>
        </div>

        <!-- Page Transaksi -->
        <div id="pageTransaksi" class="app-page">
            <!-- Header redesign based on image -->
            <div
                class="px-6 pt-12 pb-4 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-900 z-30 transition-all">
                <button onclick="navigateTo('pageHome')"
                    class="w-12 h-12 rounded-full border border-slate-100 dark:border-slate-800 flex items-center justify-center shadow-sm active:scale-95 transition-all">
                    <span class="material-icons-round text-slate-800 dark:text-white">chevron_left</span>
                </button>
                <h2 class="text-xl font-extrabold text-slate-900 dark:text-white">Riwayat Transaksi</h2>
                <button onclick="openDatePickerModal('transaction')"
                    class="w-12 h-12 rounded-full border border-slate-100 dark:border-slate-800 flex items-center justify-center shadow-sm active:scale-95 transition-all">
                    <span class="material-icons-round text-slate-800 dark:text-white">calendar_today</span>
                </button>


            </div>

            <div class="px-6 pb-4 space-y-6">
                <!-- Search Bar -->
                <div class="relative">
                    <span
                        class="material-icons-round absolute left-4 top-1/2 -translate-y-1/2 text-slate-300 text-xl">search</span>
                    <input type="text" id="transactionSearch" placeholder="Cari transaksi..."
                        oninput="handleTransactionSearch(this.value)"
                        class="w-full pl-12 pr-6 py-4 bg-slate-50 dark:bg-slate-800/50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-primary/20 transition-all">
                </div>

                <!-- Period Filter -->
                <div class="flex gap-2 overflow-x-auto hide-scrollbar">
                    <button onclick="filterPeriod('all')" id="periodAll"
                        class="px-5 py-2 rounded-xl text-[10px] font-bold transition-all whitespace-nowrap bg-primary text-white shadow-md shadow-primary/20">Semua
                        Waktu</button>
                    <button onclick="filterPeriod('month')" id="periodMonth"
                        class="px-5 py-2 rounded-xl text-[10px] font-bold transition-all whitespace-nowrap bg-white dark:bg-slate-800 text-slate-500 border border-slate-100 dark:border-slate-700">Bulan
                        Ini</button>
                </div>


                <!-- Filter Pills -->
                <div class="flex gap-2 overflow-x-auto hide-scrollbar pb-1">
                    <button onclick="filterTransactionType('all')" id="filterAll"
                        class="px-6 py-2.5 rounded-full text-[11px] font-bold transition-all whitespace-nowrap bg-indigo-600 text-white shadow-lg shadow-indigo-200/50">Semua</button>
                    <button onclick="filterTransactionType('in')" id="filterIn"
                        class="px-6 py-2.5 rounded-full text-[11px] font-bold transition-all whitespace-nowrap bg-white dark:bg-slate-800 text-slate-500 border border-slate-100 dark:border-slate-700">Dana
                        Masuk</button>
                    <button onclick="filterTransactionType('out')" id="filterOut"
                        class="px-6 py-2.5 rounded-full text-[11px] font-bold transition-all whitespace-nowrap bg-white dark:bg-slate-800 text-slate-500 border border-slate-100 dark:border-slate-700">Dana
                        Keluar</button>
                </div>

                <!-- List Header -->
                <div class="flex justify-between items-center">
                    <h3 id="transactionListHeader" class="text-xs font-bold text-slate-400 uppercase tracking-widest">
                        Terbaru</h3>
                    <button id="clearDateFilter" class="hidden text-xs font-bold text-rose-500"
                        onclick="clearSpecificDateFilter()">Hapus Filter</button>
                    <button class="text-xs font-bold text-indigo-500"
                        onclick="alert('Fitur grafik segara hadir!')">Lihat Grafik</button>
                </div>

            </div>

            <!-- Transaction List -->
            <div id="transaksiList" class="flex-1 overflow-y-auto px-6 pb-24 space-y-4 hide-scrollbar">
                <!-- Data injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- Data State ---
        let totalPemasukan = 0;
        let totalPengeluaran = 0;
        let riwayatTransaksi = [];
        let allBudgets = {}; // Store budgets indexed by month (e.g., "2026-02")
        let currentBrowseMonth = new Date();
        currentBrowseMonth.setDate(1);
        let isBalanceVisible = true;
        let transactionTypeFilter = 'all';
        let transactionPeriodFilter = 'all';
        let rekapTypeFilter = 'all';
        let transactionSearchQuery = '';
        let selectedSpecificDate = null;

        // --- Internal State for Data Persistence ---
        let isInternalUpdate = false;

        function getBudgetMonthKey() {
            return `${currentBrowseMonth.getFullYear()}-${(currentBrowseMonth.getMonth() + 1).toString().padStart(2, '0')}`;
        }

        // --- Login / Session Logic ---
        let currentUserKey = null;

        function handleLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('loginModal').classList.add('flex');
            document.getElementById('loginName').focus();
        }

        function closeLoginModal() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('flex');
        }

        function processLogin(event) {
            event.preventDefault();
            const name = document.getElementById('loginName').value.trim();
            const address = document.getElementById('loginAddress').value.trim();

            if (!name || !address) {
                alert('Nama dan Alamat harus diisi!');
                return;
            }

            // Generate unique key based on Name + Address
            const userIdentifier = btoa(name.toLowerCase() + '_' + address.toLowerCase());
            currentUserKey = `finansial_user_${userIdentifier}`;

            // Save session
            localStorage.setItem('finansial_last_user', currentUserKey);

            // Close modal
            closeLoginModal();

            // Load user data
            loadData();

            // Force update profile info in UI since we have it from login
            document.getElementById('editNamaLengkap').value = name;
            document.getElementById('editAddress').value = address;
            document.getElementById('modalProfileName').innerText = name;

            // Save this new profile data immediately to the new key ensures consistency
            saveData();

            alert(`Selamat datang kembali, ${name}!`);
        }

        function handleLogout() {
            if (confirm('Yakin ingin keluar akun?')) {
                currentUserKey = null;
                localStorage.removeItem('finansial_last_user');

                // Reset to guest/empty state
                riwayatTransaksi = [];
                totalPemasukan = 0;
                totalPengeluaran = 0;
                allBudgets = {};

                // Reset UI Inputs
                document.getElementById('editNamaLengkap').value = '';
                document.getElementById('editEmail').value = '';
                document.getElementById('editPhone').value = '';
                document.getElementById('editAddress').value = '';
                document.getElementById('modalProfileName').innerText = 'Pengguna';

                // Update UI
                updateDisplay();
                updateAllBudgetProgress();
                updateRekapList();
                updateTransaksiList();

                // Toggle Buttons
                document.getElementById('btnLogin').classList.remove('hidden');
                document.getElementById('btnLogout').classList.add('hidden');

                navigateTo('pageHome');
            }
        }

        // --- Data Persistence Overrides ---

        function getStorageKey() {
            // Priority: Current Session Key > Last Logged In Key > Default Guest Key
            if (currentUserKey) return currentUserKey;
            return 'finansial_guest_data';
        }

        function saveData() {
            if (isInternalUpdate) return;
            try {
                const key = getStorageKey();
                const profileObj = {};
                const elNama = document.getElementById('editNamaLengkap');
                const elEmail = document.getElementById('editEmail');
                const elPhone = document.getElementById('editPhone');
                const elAddress = document.getElementById('editAddress');
                const elAvatar = document.getElementById('modalAvatar');

                if (elNama) profileObj.nama = elNama.value;
                if (elEmail) profileObj.email = elEmail.value;
                if (elPhone) profileObj.phone = elPhone.value;
                if (elAddress) profileObj.address = elAddress.value;
                if (elAvatar) profileObj.avatar = elAvatar.src;

                // Update current month's budget in memory before saving
                const monthKey = getBudgetMonthKey();
                const currentMonthBudget = {};
                const categories = ['Pokok', 'Transport', 'Hiburan', 'Tagihan', 'Lain'];
                categories.forEach(cat => {
                    const el = document.getElementById(`limit${cat}`);
                    if (el) currentMonthBudget[cat] = el.value;
                });

                allBudgets[monthKey] = currentMonthBudget;

                const data = {
                    riwayatTransaksi,
                    profile: profileObj,
                    budgets: allBudgets
                };

                localStorage.setItem(key, JSON.stringify(data));
                // console.log('Data saved to', key);
            } catch (e) {
                console.error('Gagal menyimpan data:', e);
            }
        }

        function loadData() {
            isInternalUpdate = true;
            try {
                // Check if we have a last user session to auto-login
                if (!currentUserKey) {
                    const lastUser = localStorage.getItem('finansial_last_user');
                    if (lastUser) currentUserKey = lastUser;
                }

                const key = getStorageKey();
                const savedData = localStorage.getItem(key);

                if (currentUserKey) {
                    document.getElementById('btnLogin').classList.add('hidden');
                    document.getElementById('btnLogout').classList.remove('hidden');
                } else {
                    document.getElementById('btnLogin').classList.remove('hidden');
                    document.getElementById('btnLogout').classList.add('hidden');
                }

                if (savedData) {
                    const data = JSON.parse(savedData);

                    // Restore Transactions
                    riwayatTransaksi = data.riwayatTransaksi || [];
                    riwayatTransaksi.forEach(t => t.tanggal = new Date(t.tanggal));

                    // Recalculate Totals
                    totalPemasukan = 0;
                    totalPengeluaran = 0;
                    riwayatTransaksi.forEach(t => {
                        if (t.tipe === 'pemasukan') totalPemasukan += t.jumlah;
                        else totalPengeluaran += t.jumlah;
                    });

                    // Restore Profile
                    if (data.profile) {
                        const p = data.profile;
                        const elNama = document.getElementById('editNamaLengkap');
                        const elEmail = document.getElementById('editEmail');
                        const elPhone = document.getElementById('editPhone');
                        const elAddress = document.getElementById('editAddress');
                        const elAvatar = document.getElementById('modalAvatar');
                        const elModalName = document.getElementById('modalProfileName');

                        if (p.nama && elNama) elNama.value = p.nama;
                        if (p.nama && elModalName) elModalName.innerText = p.nama;
                        if (p.email && elEmail) elEmail.value = p.email;
                        if (p.phone && elPhone) elPhone.value = p.phone;
                        if (p.address && elAddress) elAddress.value = p.address;
                        if (p.avatar && elAvatar) elAvatar.src = p.avatar;
                    }

                    // Restore Budgets
                    allBudgets = data.budgets || {};
                    syncBudgetUI();
                } else {
                    // New user or empty guest
                    riwayatTransaksi = [];
                    totalPemasukan = 0;
                    totalPengeluaran = 0;
                    allBudgets = {};
                    syncBudgetUI(); // Clear UI inputs
                }
            } catch (e) {
                console.error('Gagal memuat data:', e);
            }

            updateDisplay();
            updateAllBudgetProgress();
            updateRekapList();
            updateTransaksiList();
            isInternalUpdate = false;
        }

        // Initial Load moved to window listener
        // Original generateTransactionHTML code...

        function syncBudgetUI() {
            const monthKey = getBudgetMonthKey();
            const currentMonthBudget = allBudgets[monthKey];
            const categories = ['Pokok', 'Transport', 'Hiburan', 'Tagihan', 'Lain'];

            // Default values if no budget exists for this month
            const defaults = {
                'Pokok': '',
                'Transport': '',
                'Hiburan': '',
                'Tagihan': '',
                'Lain': ''
            };

            isInternalUpdate = true; // Prevent saveData during UI sync
            categories.forEach(cat => {
                const el = document.getElementById(`limit${cat}`);
                if (el) {
                    el.value = (currentMonthBudget && currentMonthBudget[cat]) ? currentMonthBudget[cat] : defaults[cat];
                }
            });
            isInternalUpdate = false;
        }

        // Helper to save specifically one part if needed, but saveData is now unified
        function saveProfileData() { saveData(); }
        function saveBudgetLimits() { saveData(); }

        // --- UI Update Helpers ---
        function updateDisplay() {
            const saldo = totalPemasukan - totalPengeluaran;
            document.getElementById('totalPemasukan').innerText = isBalanceVisible ? 'Rp ' + totalPemasukan.toLocaleString('id-ID') : 'Rp ******';
            document.getElementById('totalPengeluaran').innerText = isBalanceVisible ? '-Rp ' + totalPengeluaran.toLocaleString('id-ID') : '-Rp ******';
            document.getElementById('totalSaldo').innerText = isBalanceVisible ? 'Rp ' + (totalPemasukan - totalPengeluaran).toLocaleString('id-ID') : 'Rp ******';

            // Also update the eye icon state
            document.getElementById('balanceEyeIcon').innerText = isBalanceVisible ? 'visibility' : 'visibility_off';
        }

        function toggleBalanceVisibility() {
            isBalanceVisible = !isBalanceVisible;
            updateDisplay();
        }


        function formatRupiah(input) {
            let value = input.value.replace(/\D/g, '');
            if (value) {
                value = parseInt(value).toLocaleString('id-ID');
            }
            input.value = value;
        }

        // --- Pemasukan Logic ---

        function savePemasukan(event) {
            event.preventDefault();
            const jumlahStr = document.getElementById('jumlahPemasukan').value;
            const jumlah = parseInt(jumlahStr.replace(/\D/g, '')) || 0;
            const keterangan = document.getElementById('keteranganPemasukan').value;

            if (jumlah > 0) {
                totalPemasukan += jumlah;
                riwayatTransaksi.push({
                    tipe: 'pemasukan',
                    jumlah: jumlah,
                    keterangan: keterangan || 'Pemasukan',
                    tanggal: new Date()
                });
                saveData();
                updateDisplay();
                alert('Pemasukan berhasil ditambahkan!');
                document.getElementById('pemasukanForm').reset();
                navigateTo('pageHome');
            }
        }

        // --- Pengeluaran Logic ---

        function savePengeluaran(event) {
            event.preventDefault();
            const jumlahStr = document.getElementById('jumlahPengeluaran').value;
            const jumlah = parseInt(jumlahStr.replace(/\D/g, '')) || 0;
            const keterangan = document.getElementById('keteranganPengeluaran').value;
            const kategori = document.getElementById('kategoriPengeluaran').value;

            if (jumlah > 0) {
                totalPengeluaran += jumlah;
                riwayatTransaksi.push({
                    tipe: 'pengeluaran',
                    jumlah: jumlah,
                    keterangan: keterangan || 'Pengeluaran',
                    kategori: kategori,
                    tanggal: new Date()
                });
                saveData();
                updateDisplay();
                updateAllBudgetProgress();
                alert('Pengeluaran berhasil ditambahkan!');
                document.getElementById('pengeluaranForm').reset();
                navigateTo('pageHome');
            }
        }

        // --- Rekap & Transaction History Logic ---

        // --- Rekap & Transaction History Logic ---

        function toggleRekapTypeFilter() {
            // Reset to 'all' as requested
            rekapTypeFilter = 'all';
            document.getElementById('rekapTypeLabel').textContent = 'Semua';
            updateRekapList();
        }


        function handleRekapMonthChange(monthStr) {
            if (monthStr) {
                const [year, month] = monthStr.split('-').map(Number);
                currentBrowseMonth = new Date(year, month - 1, 1);
                updateRekapList();
            }
        }

        function updateRekapList() {
            const container = document.getElementById('rekapList');
            const targetMonth = currentBrowseMonth;

            // Filter by month
            let transFiltered = riwayatTransaksi.filter(t => {
                const tgl = new Date(t.tanggal);
                return tgl.getMonth() === targetMonth.getMonth() && tgl.getFullYear() === targetMonth.getFullYear();
            });

            // Filter by type
            if (rekapTypeFilter !== 'all') {
                transFiltered = transFiltered.filter(t => t.tipe === rekapTypeFilter);
            }

            if (transFiltered.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 opacity-40">
                        <span class="material-icons-round text-6xl mb-4 text-slate-300 dark:text-slate-600">assignment_late</span>
                        <p class="text-sm font-semibold text-slate-400">Belum ada transaksi</p>
                    </div>`;
                return;
            }

            container.innerHTML = [...transFiltered].reverse().map(t => generateRekapCardHTML(t)).join('');
        }

        function generateRekapCardHTML(t) {
            const tgl = new Date(t.tanggal);
            const dateStr = tgl.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
            const isIncome = t.tipe === 'pemasukan';

            // Icon Logic
            let icon = isIncome ? 'arrow_downward' : 'arrow_upward';
            let iconBg = isIncome ? 'bg-green-500/10 text-green-500' : 'bg-rose-500/10 text-rose-500';

            if (t.kategori === 'Transport') { icon = 'directions_car'; iconBg = 'bg-blue-500/10 text-blue-500'; }
            if (t.kategori === 'Makan') { icon = 'restaurant'; iconBg = 'bg-orange-500/10 text-orange-500'; }
            if (t.kategori === 'Belanja') { icon = 'shopping_bag'; iconBg = 'bg-purple-500/10 text-purple-500'; }

            return `
                <div class="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl flex items-center justify-between border border-slate-100 dark:border-slate-700/50">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 rounded-xl ${iconBg} flex items-center justify-center">
                            <span class="material-icons-round text-2xl">${icon}</span>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-800 dark:text-slate-200 text-sm mb-0.5 capitalize">${t.keterangan}</h4>
                            <p class="text-[10px] font-medium text-slate-400">${dateStr} • ${t.kategori || (isIncome ? 'Pemasukan' : 'Pengeluaran')}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-sm ${isIncome ? 'text-green-500' : 'text-rose-500'}">
                            ${isIncome ? '+' : '-'}Rp ${t.jumlah.toLocaleString('id-ID')}
                        </p>
                        <span class="text-[9px] font-bold text-teal-500 bg-teal-500/10 px-1.5 py-0.5 rounded uppercase tracking-wider">BERHASIL</span>
                    </div>
                </div>
            `;
        }


        function handleMonthSelect(monthStr) {
            if (!monthStr) {
                selectedSpecificDate = null;
            } else {
                // monthStr format is "YYYY-MM"
                const [year, month] = monthStr.split('-').map(Number);
                selectedSpecificDate = new Date(year, month - 1, 1);

                // Sync currentBrowseMonth to the selected month
                currentBrowseMonth = new Date(selectedSpecificDate);

                // Update header text
                const options = { month: 'long', year: 'numeric' };
                document.getElementById('transactionListHeader').textContent = 'Transaksi: ' + selectedSpecificDate.toLocaleDateString('id-ID', options);
                document.getElementById('clearDateFilter').classList.remove('hidden');
                transactionPeriodFilter = 'date'; // Reserving 'date' logic for single-month view override
                updatePeriodUI();
            }
            updateTransaksiList();
            updateBudgetMonthDisplay();
        }


        function clearSpecificDateFilter() {
            selectedSpecificDate = null;
            transactionPeriodFilter = 'all';
            document.getElementById('transactionDatePicker').value = '';
            document.getElementById('transactionListHeader').textContent = 'Terbaru';
            document.getElementById('clearDateFilter').classList.add('hidden');
            updatePeriodUI();
            updateTransaksiList();
        }

        function filterPeriod(period) {
            transactionPeriodFilter = period;
            selectedSpecificDate = null;
            document.getElementById('transactionDatePicker').value = '';
            document.getElementById('clearDateFilter').classList.add('hidden');
            document.getElementById('transactionListHeader').textContent = 'Terbaru';

            updatePeriodUI();
            updateTransaksiList();
        }

        function updatePeriodUI() {
            const periods = ['all', 'month'];
            periods.forEach(p => {
                const btn = document.getElementById('period' + p.charAt(0).toUpperCase() + p.slice(1));
                if (btn) {
                    if (p === transactionPeriodFilter) {
                        btn.className = "px-5 py-2 rounded-xl text-[10px] font-bold transition-all whitespace-nowrap bg-primary text-white shadow-md shadow-primary/20";
                    } else {
                        btn.className = "px-5 py-2 rounded-xl text-[10px] font-bold transition-all whitespace-nowrap bg-white dark:bg-slate-800 text-slate-500 border border-slate-100 dark:border-slate-700";
                    }
                }
            });
        }




        function updateTransaksiList() {
            const container = document.getElementById('transaksiList');
            if (!container) return;

            const targetMonth = currentBrowseMonth;

            // Filtering Logic
            let transFiltered = riwayatTransaksi.filter(t => {
                const tgl = new Date(t.tanggal);

                let dateMatch = false;
                if (transactionPeriodFilter === 'date' && selectedSpecificDate) {
                    // In "Monthly Range" mode (via calendar logo), we filter by the selected month/year
                    dateMatch = tgl.getMonth() === selectedSpecificDate.getMonth() &&
                        tgl.getFullYear() === selectedSpecificDate.getFullYear();
                } else if (transactionPeriodFilter === 'month') {
                    // "Bulan Ini" filter
                    const now = new Date();
                    dateMatch = tgl.getMonth() === now.getMonth() && tgl.getFullYear() === now.getFullYear();
                } else {
                    // Default 'all'
                    dateMatch = true;
                }


                const typeMatch = transactionTypeFilter === 'all' ||
                    (transactionTypeFilter === 'in' && t.tipe === 'pemasukan') ||
                    (transactionTypeFilter === 'out' && t.tipe === 'pengeluaran');

                const searchMatch = !transactionSearchQuery ||
                    t.keterangan.toLowerCase().includes(transactionSearchQuery.toLowerCase());

                return dateMatch && typeMatch && searchMatch;
            });



            if (transFiltered.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 opacity-40">
                        <span class="material-icons-round text-6xl mb-4">search_off</span>
                        <p class="text-sm font-semibold">Tidak ada transaksi ditemukan</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = [...transFiltered].reverse().map(t => generateTransactionHTML(t)).join('');
        }

        function handleTransactionSearch(query) {
            transactionSearchQuery = query;
            updateTransaksiList();
        }

        function filterTransactionType(type) {
            transactionTypeFilter = type;

            // Update UI buttons
            const types = ['all', 'in', 'out'];
            types.forEach(t => {
                const btn = document.getElementById('filter' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    if (t === type) {
                        btn.className = "px-6 py-2.5 rounded-full text-[11px] font-bold transition-all whitespace-nowrap bg-indigo-600 text-white shadow-lg shadow-indigo-200/50";
                    } else {
                        btn.className = "px-6 py-2.5 rounded-full text-[11px] font-bold transition-all whitespace-nowrap bg-white dark:bg-slate-800 text-slate-500 border border-slate-100 dark:border-slate-700";
                    }
                }
            });

            updateTransaksiList();
        }

        // --- Navigation Logic ---
        function navigateTo(targetId) {
            const pages = document.querySelectorAll('.app-page');
            pages.forEach(p => p.classList.remove('active'));

            const targetPage = document.getElementById(targetId);
            if (targetPage) {
                targetPage.classList.add('active');

                // Update bottom navigation & header tabs highlight
                updateNavHighlight(targetId);

                // Page-specific initializations
                if (targetId === 'pageRekap') updateRekapList();
                if (targetId === 'pageAnggaran') {
                    updateBudgetMonthDisplay();
                    updateAllBudgetProgress();
                }
                if (targetId === 'pageTransaksi') updateTransaksiList();
            }
        }

        function updateNavHighlight(targetId) {
            // Mapping targetId to nav and tab IDs
            const navMap = {
                'pageHome': 'navHome',
                'pageRekap': 'navRekap',
                'pageTransaksi': 'navTransaksi',
                'pageProfil': 'navProfil'
            };

            const tabMap = {
                'pageHome': 'tabHome',
                'pageRekap': 'tabRekap',
                'pageTransaksi': 'tabTransaksi'
            };

            // Reset all bottom nav items
            ['navHome', 'navRekap', 'navTransaksi', 'navProfil'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('text-primary');
                    el.classList.add('text-slate-400');
                }
            });

            // Highlight active bottom nav item
            if (navMap[targetId]) {
                const activeNav = document.getElementById(navMap[targetId]);
                if (activeNav) {
                    activeNav.classList.remove('text-slate-400');
                    activeNav.classList.add('text-primary');
                }
            }

            // Reset all header tabs
            ['tabHome', 'tabRekap', 'tabTransaksi'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.classList.remove('opacity-100', 'border-b-2', 'border-white', 'pb-1');
                    el.classList.add('opacity-60');
                }
            });

            // Highlight active header tab
            if (tabMap[targetId]) {
                const activeTab = document.getElementById(tabMap[targetId]);
                if (activeTab) {
                    activeTab.classList.remove('opacity-60');
                    activeTab.classList.add('opacity-100', 'border-b-2', 'border-white', 'pb-1');
                }
            }
        }

        function savePersonalData() {
            const newName = document.getElementById('editNamaLengkap').value;
            const newEmail = document.getElementById('editEmail').value;
            const newPhone = document.getElementById('editPhone').value;
            const newAddress = document.getElementById('editAddress').value;

            if (newName.trim() === '') {
                alert('Nama tidak boleh kosong!');
                return;
            }

            if (!newEmail.includes('@')) {
                alert('Format email tidak valid!');
                return;
            }

            // Update modal display (for the name in profile header)
            document.getElementById('modalProfileName').innerText = newName;

            saveProfileData();

            alert('Data pribadi berhasil diperbarui!');
            navigateTo('pagePengaturan');
        }

        function handleResetSandi(event) {
            event.preventDefault();
            const sandiBaru = document.getElementById('sandiBaru').value;
            const sandiKonfirmasi = document.getElementById('sandiKonfirmasi').value;

            if (sandiBaru !== sandiKonfirmasi) {
                alert('Konfirmasi sandi tidak cocok dengan sandi baru!');
                return;
            }

            if (sandiBaru.length < 6) {
                alert('Sandi baru minimal 6 karakter!');
                return;
            }

            alert('Kata sandi berhasil diperbarui!');
            navigateTo('pagePengaturan');
        }



        function changeBudgetMonth(step) {
            currentBrowseMonth.setMonth(currentBrowseMonth.getMonth() + step);
            updateBudgetMonthDisplay();
            syncBudgetUI();
            updateAllBudgetProgress();
            updateRekapList();
            updateTransaksiList();
        }

        function updateBudgetMonthDisplay() {
            const display = document.getElementById('budgetMonthDisplay');
            if (display) {
                const monthName = currentBrowseMonth.toLocaleString('id-ID', { month: 'long', year: 'numeric' });
                display.innerText = monthName;
            }
        }

        function updateAllBudgetProgress() {
            const categories = ['Pokok', 'Transport', 'Hiburan', 'Tagihan', 'Lain'];
            categories.forEach(cat => updateBudgetProgress(cat));
        }

        function updateBudgetProgress(category) {
            const limit = parseInt(document.getElementById(`limit${category}`).value) || 0;
            saveBudgetLimits();

            // Calculate total spent for this category in the current selected month
            const used = riwayatTransaksi
                .filter(t => t.tipe === 'pengeluaran' && t.kategori === category)
                .filter(t => {
                    const tgl = new Date(t.tanggal);
                    return tgl.getMonth() === currentBrowseMonth.getMonth() &&
                        tgl.getFullYear() === currentBrowseMonth.getFullYear();
                })
                .reduce((sum, t) => sum + t.jumlah, 0);

            const progress = document.getElementById(`progress${category}`);
            const usedLabel = document.getElementById(`used${category}`);

            // Update text label
            if (usedLabel) {
                usedLabel.innerText = 'Rp ' + used.toLocaleString('id-ID');
            }



            if (limit === 0) {
                progress.style.width = '0%';
                return;
            }

            const percentage = Math.min((used / limit) * 100, 100);
            progress.style.width = `${percentage}%`;

            if (percentage > 90) {
                progress.className = "h-full bg-rose-500 rounded-full transition-all duration-500";
            } else if (percentage > 70) {
                progress.className = "h-full bg-orange-500 rounded-full transition-all duration-500";
            } else {
                const defaultColors = {
                    'Pokok': 'bg-primary',
                    'Transport': 'bg-teal-500',
                    'Hiburan': 'bg-purple-500',
                    'Tagihan': 'bg-orange-500',
                    'Lain': 'bg-slate-500'
                };
                progress.className = `h-full ${defaultColors[category]} rounded-full transition-all duration-500`;
            }
        }




        function togglePasswordVisibility(inputId, iconId) {
            const input = document.getElementById(inputId);
            const icon = document.getElementById(iconId);
            if (input.type === 'password') {
                input.type = 'text';
                icon.innerText = 'visibility_off';
            } else {
                input.type = 'password';
                icon.innerText = 'visibility';
            }
        }


        // --- Profile Photo Logic ---
        function triggerPhotoUpload() {
            document.getElementById('profilePhotoInput').click();
        }

        function handleProfilePhotoChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const newPhotoUrl = e.target.result;
                    // Update all profile image instances
                    document.getElementById('modalAvatar').src = newPhotoUrl;

                    // Note: If you add a profile image to the header later, 
                    // update it here using its ID (e.g., document.getElementById('headerAvatar').src = newPhotoUrl;)

                    saveProfileData();
                    alert('Foto profil berhasil diperbarui!');
                }
                reader.readAsDataURL(file);
            }
        }

        function generateTransactionHTML(t) {
            const tgl = new Date(t.tanggal);
            const dateStr = tgl.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });
            const timeStr = tgl.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
            const isIncome = t.tipe === 'pemasukan';

            // Map category codes to full Indonesian names
            const categoryNames = {
                'Pokok': 'Kebutuhan Pokok',
                'Transport': 'Transportasi',
                'Hiburan': 'Hiburan',
                'Tagihan': 'Tagihan',
                'Lain': 'Lain-lain'
            };

            // Use category name for expenses, or user-provided description
            const keterangan = t.keterangan || (isIncome ? 'Dana Masuk' : (categoryNames[t.kategori] || 'Pengeluaran'));

            // Define styles for each color to avoid dynamic class issues
            const colorStyles = {
                orange: { bg: 'bg-orange-50', darkBg: 'dark:bg-orange-900/20', text: 'text-orange-500', border: 'border-orange-100/50' },
                indigo: { bg: 'bg-indigo-50', darkBg: 'dark:bg-indigo-900/20', text: 'text-indigo-500', border: 'border-indigo-100/50' },
                blue: { bg: 'bg-blue-50', darkBg: 'dark:bg-blue-900/20', text: 'text-blue-500', border: 'border-blue-100/50' },
                purple: { bg: 'bg-purple-50', darkBg: 'dark:bg-purple-900/20', text: 'text-purple-500', border: 'border-purple-100/50' },
                emerald: { bg: 'bg-emerald-50', darkBg: 'dark:bg-emerald-900/20', text: 'text-emerald-500', border: 'border-emerald-100/50' },
                rose: { bg: 'bg-rose-50', darkBg: 'dark:bg-rose-900/20', text: 'text-rose-500', border: 'border-rose-100/50' },
                cyan: { bg: 'bg-cyan-50', darkBg: 'dark:bg-cyan-900/20', text: 'text-cyan-500', border: 'border-cyan-100/50' },
                slate: { bg: 'bg-slate-50', darkBg: 'dark:bg-slate-900/20', text: 'text-slate-500', border: 'border-slate-100/50' },
                teal: { bg: 'bg-teal-50', darkBg: 'dark:bg-teal-900/20', text: 'text-teal-500', border: 'border-teal-100/50' }
            };

            // Map categories to icons and colors
            const catMap = {
                'Marketplace': { icon: 'shopping_bag', color: 'orange' },
                'Top Up': { icon: 'account_balance_wallet', color: 'indigo' },
                'Delivery': { icon: 'restaurant', color: 'blue' },
                'Entertainment': { icon: 'movie', color: 'purple' },
                'Salary': { icon: 'payments', color: 'emerald' },
                'Utilities': { icon: 'electric_bolt', color: 'rose' },
                'Health': { icon: 'local_hospital', color: 'cyan' },
                'Pokok': { icon: 'shopping_cart', color: 'orange' },
                'Transport': { icon: 'directions_car', color: 'teal' },
                'Hiburan': { icon: 'theater_comedy', color: 'purple' },
                'Tagihan': { icon: 'receipt_long', color: 'rose' },
                'Lain': { icon: 'category', color: 'slate' }
            };

            // Determine config
            let config;
            if (isIncome) {
                config = { icon: 'payments', color: 'emerald' };
            } else {
                config = catMap[t.kategori] || catMap['Lain'];
            }

            // Safety check for string methods on description override
            if (typeof keterangan === 'string') {
                if (keterangan.toLowerCase().includes('top up')) { config = { icon: 'account_balance_wallet', color: 'indigo' }; }
                if (keterangan.toLowerCase().includes('pesan antar')) { config = { icon: 'restaurant', color: 'blue' }; }
            }

            // Get styles based on color
            const style = colorStyles[config.color] || colorStyles['slate'];

            return `
                <div class="bg-white dark:bg-slate-800/80 p-5 rounded-3xl border border-slate-50 dark:border-slate-700/50 shadow-sm flex items-center justify-between group active:scale-[0.98] transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 ${style.bg} ${style.darkBg} rounded-2xl flex items-center justify-center ${style.text} shadow-sm border ${style.border}">
                            <span class="material-icons-round text-2xl">${config.icon}</span>
                        </div>
                        <div>
                            <p class="text-sm font-bold text-slate-900 dark:text-white mb-0.5 line-clamp-1">${keterangan}</p>
                            <p class="text-[10px] font-medium text-slate-400 capitalize">${dateStr} • ${timeStr} • ${t.kategori || (isIncome ? 'Pemasukan' : 'Pengeluaran')}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="text-sm font-extrabold ${isIncome ? 'text-emerald-500' : 'text-slate-900 dark:text-white'}">
                            ${isIncome ? '+' : '-'}Rp ${t.jumlah.toLocaleString('id-ID')}
                        </p>
                        <span class="text-[8px] font-bold tracking-widest ${isIncome || t.status !== 'diproses' ? 'text-emerald-500' : 'text-orange-500'}">
                            ${(t.status || 'BERHASIL').toUpperCase()}
                        </span>
                    </div>
                </div>
            `;
        }

        // Initial Load
        window.addEventListener('DOMContentLoaded', () => {
            loadData();
            updateNavHighlight('pageHome');
        });
    </script>
    <input type="file" id="profilePhotoInput" accept="image/*" class="hidden"
        onchange="handleProfilePhotoChange(event)">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeLoginModal()"></div>
        <div
            class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl relative z-10 transform transition-all scale-100">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-indigo-100 dark:bg-indigo-900/30 rounded-2xl flex items-center justify-center text-indigo-600 mx-auto mb-4">
                    <span class="material-icons-round text-3xl">lock_person</span>
                </div>
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Masuk Akun</h3>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">Masukkan data diri untuk mengakses riwayat.
                </p>
            </div>

            <form onsubmit="processLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Nama
                        Lengkap</label>
                    <input type="text" id="loginName" required placeholder="Contoh: Budi Santoso"
                        class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Alamat
                        Kota</label>
                    <input type="text" id="loginAddress" required placeholder="Contoh: Jakarta"
                        class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>

                <button type="submit"
                    class="w-full py-4 bg-indigo-600 text-white font-bold rounded-2xl shadow-lg shadow-indigo-600/30 active:scale-95 transition-all text-sm tracking-wide mt-2">
                    Masuk Sekarang
                </button>
                <button type="button" onclick="closeLoginModal()"
                    class="w-full py-4 text-slate-400 font-bold text-xs tracking-wide hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                    Batal
                </button>
            </form>
        </div>
    </div>

    <!-- Date Picker Modal -->
    <div id="datePickerModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeDatePickerModal()"></div>
        <div class="bg-white dark:bg-slate-800 w-full max-w-sm rounded-[2rem] p-6 shadow-2xl relative z-10">
            <div class="text-center mb-6">
                <div
                    class="w-16 h-16 bg-blue-100 dark:bg-blue-900/30 rounded-2xl flex items-center justify-center text-blue-600 mx-auto mb-4">
                    <span class="material-icons-round text-3xl">calendar_month</span>
                </div>
                <h3 class="text-xl font-bold text-slate-900 dark:text-white">Pilih Bulan</h3>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Bulan</label>
                    <select id="modalMonth"
                        class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="0">Januari</option>
                        <option value="1">Februari</option>
                        <option value="2">Maret</option>
                        <option value="3">April</option>
                        <option value="4">Mei</option>
                        <option value="5">Juni</option>
                        <option value="6">Juli</option>
                        <option value="7">Agustus</option>
                        <option value="8">September</option>
                        <option value="9">Oktober</option>
                        <option value="10">November</option>
                        <option value="11">Desember</option>
                    </select>
                </div>
                <div>
                    <label class="block text-[10px] uppercase tracking-widest text-slate-400 mb-2 ml-2">Tahun</label>
                    <select id="modalYear"
                        class="w-full px-6 py-4 bg-slate-50 dark:bg-slate-800/50 border border-slate-100 dark:border-slate-700 rounded-2xl text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </select>
                </div>

                <button type="button" onclick="applyDateFilter()"
                    class="w-full py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-lg shadow-blue-600/30 active:scale-95 transition-all text-sm tracking-wide mt-2">
                    Terapkan
                </button>
                <button type="button" onclick="closeDatePickerModal()"
                    class="w-full py-4 text-slate-400 font-bold text-xs tracking-wide hover:text-slate-600 dark:hover:text-slate-300 transition-colors">
                    Batal
                </button>
            </div>
        </div>
    </div>

    <script>
        // Date Picker Modal Logic
        let datePickerTarget = null; // 'transaction' or 'rekap'

        function openDatePickerModal(target) {
            datePickerTarget = target;
            const modal = document.getElementById('datePickerModal');
            const monthSelect = document.getElementById('modalMonth');
            const yearSelect = document.getElementById('modalYear');

            // Set current month
            monthSelect.value = currentBrowseMonth.getMonth();

            // Populate years (5 years back and 2 years forward)
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let y = currentYear - 5; y <= currentYear + 2; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                if (y === currentBrowseMonth.getFullYear()) option.selected = true;
                yearSelect.appendChild(option);
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeDatePickerModal() {
            const modal = document.getElementById('datePickerModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function applyDateFilter() {
            const month = parseInt(document.getElementById('modalMonth').value);
            const year = parseInt(document.getElementById('modalYear').value);

            selectedSpecificDate = new Date(year, month, 1);
            currentBrowseMonth = new Date(selectedSpecificDate);

            const options = { month: 'long', year: 'numeric' };
            const dateLabel = selectedSpecificDate.toLocaleDateString('id-ID', options);

            if (datePickerTarget === 'transaction') {
                document.getElementById('transactionListHeader').textContent = 'Transaksi: ' + dateLabel;
                document.getElementById('clearDateFilter').classList.remove('hidden');
                transactionPeriodFilter = 'date';
                updatePeriodUI();
                updateTransaksiList();
            } else if (datePickerTarget === 'rekap') {
                handleRekapMonthChange(year + '-' + String(month + 1).padStart(2, '0'));
            }

            updateBudgetMonthDisplay();
            closeDatePickerModal();
        }
    </script>
</body>

</html>